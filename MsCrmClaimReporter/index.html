
<!DOCTYPE html> 
<html>
<head>
	<title>Page Title</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />


    <script type="text/x-jsrender" id="startupScreenTemplate">
        <div data-role="page" id="startupScreen">
            <div data-role="header" data-fullscreen="true" id="header1">
		        <h1>Claim Expenses</h1>
	        </div>
                      
	        <div data-role="content">
                <div id="loginControls">
                    <h2>Connect to Microsoft Dynamics CRM to claim your expenses</h2>
                    <h4>Username: demo@jaydata.onmicrosoft.com</h4>
                    <h4>Password: OData2013</h4>
        <input />
                    <a href="#" id="doLogin" data-inline="true" data-icon="arrow-r" data-iconpos="right" data-role="button">Login to CRM</a>
                    <a href="https://login.microsoftonline.com/logout.srf">Logout/change user</a>
        
                </div>
                <div id="claimControls" style="display:none">
                    <h2>Manage Expense Claims</h2>
                    <a id="add-claim" href="#createClaim" data-transition="slide" data-role="button">Create New</a>
                    <a href="#listClaims" data-role="button">List my claims</a>
                    <a href="https://login.microsoftonline.com/logout.srf">Logout/change user</a>
                </div>
	        </div>
        </div>
    </script>

    <script type="text/x-jsrender" id="createClaimTemplate">
        <div data-role="page" id="createClaim">
	        <div data-role="header">
                <a href="javascript:history.back()" data-role="button">Back</a>
                <h1>New Claim</h1>

	        </div>

            <div data-role="content">
                <h4>Project and Lead details</h4>

                <div data-role="fieldcontain" id="claim-info">
                    {^{for expenseClaim}}
                        <label for="claim-name">Project info:</label>
                        <input name="claim-name" placeholder="Example: visit lead in Vegas" id="claim-name" data-link="new_name">
                    {{/for}}
                </div>
                <div data-role="fieldcontain">
                    <label for="amount">Lead:</label>
                    {^{if selectedLead}}
                        {^{for selectedLead}}
                            <strong>{^{>FullName}}</strong>
                            <a href="#selectLead" data-transition="slide">pick different</a>
                        {{/for}}
                    {{else}}
                        <a href="#selectLead" data-transition="slide">pick lead from list</a>
                    {{/if}}
                </div>

                {^{for expenseClaim}}
                    <strong>List your expenses by item</strong>
                    <form id="claimItemsForm">
                        {^{for new_claimitems}}
                            <div class="claimInput" data-role="fieldcontain">
                                <label for="amount">Amount ($):</label>
                                <input name="amount" type="number" max="1000000" id="amount" data-link="new_Amount">
                                <label for="name">Details:</label>
                                <input name="name" id="name" data-link="new_name" placeholder="Example: taxi, dinner or gift">
                                <a href="#" class="remove-claim-item" data-role="button" data-inline="true" data-mini="true" data-icon="minus">Remove</a>
                            </div>
                        {{/for}}
                    </form>
                {{/for}}

                <a href="#" id="add-claim-item" data-role="button" 
                            data-inline="true" data-icon="plus">Add new expense item</a>

                <a href="#" id="submit-claim" data-role="button" data-inline="true" data-icon="check" data-theme="b">Place claim</a>
            </div>
        </div>
    </script>

    <script id="selectLeadTemplate" type="text/x-jsrender">
        <div data-role="page" id="selectLead">
	        <div data-role="header">
                <a href="javascript:history.back()" data-role="button">Back</a>
		        <h1>Select Lead</h1>
	        </div>

	        <div data-role="content">
                <ul id="leadList" data-role="listview" data-inset="true">
                    {^{for leads}}
                        <li><a href="javascript:history.back()" class="leadSelector" data-transition="slide">{{>FullName}}</a></li>
                    {{/for}}
                </ul>
	        </div>

        </div>
    </script>

    <script id="listClaimsTemplate" type="text/x-jsrender">
        <div data-role="page" id="listClaims">
	        <div data-role="header">
                <a href="javascript:history.back()" data-role="button">Back</a>
		        <h1>List claims</h1>
                <a href="javascript:app.listClaims()" data-role="button">Refresh</a>
	        </div>

	        <div data-role="content">
                <div id="claim-list" data-role="collapsible-set" data-corners="false" data-theme="c" data-content-theme="d">
	                {^{for claims}}
                    <div data-role="collapsible">
                        <h3>{{>new_name}}</h3>
                        <ul id="claim-item-list" data-role="listview" data-inset="true">
	                        {^{for new_claimitems}}
                                <li>
                                    <b>Description: {{>new_name}}</b><br />
                                    <b>Expense: ${{>new_Amount}}</b>
                                </li>
                            {{/for}}
                        </ul>
                    </div>
                    {{/for}}
                </div>
            </div>

        </div>
    </script>

    <script type="text/x-jsrender" id="appTemplate">
        {{include tmpl="#startupScreenTemplate" /}}
        {{include tmpl="#createClaimTemplate" /}}
        {{include tmpl="#selectLeadTemplate" /}}
        {{include tmpl="#listClaimsTemplate" /}}
    </script>
</head>

<body id="theBody">



</body>
<script src="cordova.js" type="text/javascript"></script>
<script src="http://include.jaydata.org/1.3.1beta/jquery-1.9.1.z.min.js"></script>
<script src="http://include.jaydata.org/1.3.1beta/jquery.mobile.1.3.1.z.min.js"></script>
<script src="http://include.jaydata.org/1.3.1beta/jquery.observable.z.js"></script>
<script src="http://include.jaydata.org/1.3.1beta/jsrender.z.js"></script>
<script src="http://include.jaydata.org/1.3.1beta/jquery.views.z.js"></script>
<script src="http://include.jaydata.org/1.3.1beta/datajs-1.0.3.z.min.js"></script>
<script src="http://include.jaydata.org/1.3.1beta/jaydata.z.min.js"></script>
<script src="http://include.jaydata.org/1.3.1beta/oDataProvider.z.min.js"></script>
<script src="http://include.jaydata.org/1.3.1beta/jaydatamodules/NoBatch.min.js"></script>
<script src="js/mscrm.js"></script>
<script src="jd_CrmContext.js"></script>
<script>
    $.templates({
        appTemplate: '#appTemplate'
    });


    window.onunload = function() { alert("!"); }
    var app = {
        leads: [],
        selectedLead: undefined,
        expenseClaim: undefined,
        dataContext: null,
        doLogin: function () {
            //$.mobile.loading('show', { text: 'Authorizing', textVisible: true, theme: "a" });

            //window.onmessage = function() { alert ("!!!!"); }
            window.postMessage({},"*");
            //return;
            $data.MsCrm.init("https://jaydata.crm.dynamics.com", Crm.DataContext, function (context) {
                app.dataContext = context,
                context.LeadSet
                       //.filter(function(lead) { return lead.FullName.contains('some value') }
                       .map("{ LeadId: it.LeadId, FullName: it.FullName }",null, "default")
                       .toArray(function (leads) {
                           $.observable(app.leads).insert(0, leads);
                       })
                       .then(function () {
                           $('#loginControls').hide();
                           $('#claimControls').show();
                           $.mobile.loading('hide');
                       });

            });
        },

        selectLead: function (lead) {
            $.observable(this).setProperty("selectedLead", lead);
        },

        
        addNewClaim: function() {
            var claim = new Crm.new_expenseclaim({new_expenseclaimId : $data.createGuid()});
            claim.new_claimitems = [new Crm.new_expenseclaimitem({ new_expenseclaimitemId: $data.createGuid() })];
            $.observable(this).setProperty("expenseClaim", claim);
            $('#claimItemsForm').trigger('create');
        },

        addNewClaimItem: function () {
            var claimItems = app.expenseClaim.new_claimitems;
            var claimItem = new Crm.new_expenseclaimitem({ new_expenseclaimitemId: $data.createGuid() });
            $.observable(claimItems).insert(claimItems.length, claimItem);
            $('#claimItemsForm').trigger('create');
        },

        removeClaimItem: function(index) {
            $.observable(app.expenseClaim.new_claimitems).remove(index);
        },
        
        submitClaim: function () {

            $.mobile.loading('show', { text: 'Submitting', textVisible: true, theme: "a" });
            app.dataContext.add(app.expenseClaim);

            //Dynamics CRM has a bit annoying naming scheme, 
            //nav properties are called the same on both ends
            //here expenseClaim.new_expenseclaims is in fact the Lead entity
            if (app.selectedLead) {
                app.dataContext.attach(app.selectedLead);
                app.expenseClaim.new_expenseclaims = app.selectedLead;
            }

            app.dataContext.saveChanges().then(function () {
                $.mobile.loading('hide');
                history.back();
            });
        },

        claims: undefined,
        selectedClaim: undefined,

        listClaims: function () {
            $.mobile.loading('show', { text: 'Loading...', textVisible: true, theme: "a" });
            app.dataContext
                .new_expenseclaimSet
                .include("new_claimitems")
                .order("-CreatedOn")
                .take(10)
                .toArray(function (claims) {
                    $.observable(app).setProperty("claims", claims);
                })
                .then(function () {
                    $('#claim-list').trigger('create');
                    $.mobile.loading('hide');
                });
        }
    }

    
  $.link.appTemplate('#theBody', app)
        .on('click', '#doLogin', function () { app.doLogin(); })
        .on('click', '#add-claim', function () { app.addNewClaim(); })
        .on('click', '.leadSelector', function () { app.selectLead($.view(this).data); })
        .on('click', '#add-claim-item', function () { app.addNewClaimItem(); })
        .on('click', '.remove-claim-item', function () { app.removeClaimItem($.view(this).getIndex()); })
        .on('click', '#submit-claim', function () { app.submitClaim(); })
        .on('pageshow', '#listClaims', function () {
            if (!app.claims) {
                app.listClaims();
            }
        })
        .on('pagebeforeshow', '#createClaim', function () {
            $('#createClaim').trigger('create');
        });


</script>
</html>